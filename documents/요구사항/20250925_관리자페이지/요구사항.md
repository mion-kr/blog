# 요구사항

관리자 기능 구현

## 1. 관리자 기능 개요

- Mion 전용 관리자 대시보드를 구축하여 포스트, 카테고리, 태그를 한 곳에서 관리합니다.
- NextAuth로 인증된 ADMIN 사용자만 접근할 수 있도록 서버/클라이언트 모두에서 이중 검증합니다.
- 작성 중인 포스트를 저장/미리보기하고 발행 상태를 관리하며, 통계 지표(포스트 수, 카테고리/태그 수)를 즉시 확인할 수 있어야 합니다.

## 2. 현재 구현 요약

### 2.1 백엔드 (apps/blog-api)

- Posts, Categories, Tags 컨트롤러가 `/api/...` 경로로 CRUD 엔드포인트를 제공하며 POST/PUT/DELETE 요청에 `AdminGuard` + `CsrfGuard`가 적용되어 있습니다.
- `AdminGuard`는 JWT에서 `role === 'ADMIN'` 여부를 검사하고, `JwtStrategy`는 `Authorization: Bearer <token>` 헤더를 요구합니다.
- `CsrfGuard`는 개발 환경을 제외하고 `X-CSRF-Token` 헤더 또는 본문의 `_csrf` 필드 존재 여부만 확인합니다.
- `PostsService`는 페이징/필터링/관계 조회를 지원하며 slug 중복 검사, 태그 관계 저장까지 구현되어 있습니다.
- 카테고리/태그 서비스는 중복 검사, 삭제 시 참조 유효성 검사, `updatePostCount` 보조 메서드를 제공합니다.
- 현재 `PostsService.create`에서 작성자 ID를 `'temp-user-id'`로 하드코딩하고 있습니다.

### 2.2 프론트엔드 (apps/blog-web)

- NextAuth 설정(`lib/auth-config.ts`)에서 `ADMIN_EMAIL`과 매칭되는 계정만 ADMIN 역할을 부여합니다.
- `useAuth`, `AuthButton`, `HeroActions` 등에서 ADMIN일 때 `/admin/...`으로 이동하도록 UI가 노출되어 있습니다.
- `/admin` 관련 라우트 및 UI는 아직 존재하지 않으며, 링크 클릭 시 404가 발생합니다.
- `lib/api-client.ts`는 GET 전용 헬퍼만 구현되어 있고 토큰/CSRF 주입 로직이 없습니다.
- MDX 렌더링과 공개 페이지 레이아웃/사이드바 등은 정상 동작 중입니다.

## 3. 확인된 이슈 및 리스크

- `apps/blog-api/src/posts/posts.service.ts`의 `generateSlug`가 영문/숫자만 허용하여 한글 제목이 모두 제거됩니다 → `packages/shared/src/utils/slug.ts` 재사용 필요.
- 포스트 생성/수정/삭제 시 카테고리·태그의 `postCount`를 갱신하지 않아 통계가 어긋납니다.
- 작성자 식별이 하드코딩되어 감사 추적과 권한 통제가 불가능합니다.
- 프론트엔드에서 API 호출 시 사용할 JWT, CSRF 토큰 취득/저장을 위한 인프라가 없습니다.
- `api-client`가 POST/PUT/DELETE를 지원하지 않아 관리자 UI에서 CRUD 호출이 불가능합니다.
- 관리자 경로가 없으므로 `HeroActions`와 `AuthButton`에서 링크 클릭 시 404가 발생합니다.
- CSRF Guard는 토큰 존재만 확인하므로 실제 토큰 발급/검증 전략을 정의해야 합니다.
- 새 관리자 UI 도입 시 무한 스크롤/저장 중 중복 제출 등 UX 리스크에 대한 에러 처리 규칙이 미정입니다.

## 4. 관리자 기능 상세 요구사항

### 4.1 인증·보안 파이프라인

- NextAuth JWT를 서버 컴포넌트/서버 액션에서 `getToken`으로 획득하고 `Authorization: Bearer` 헤더로 API에 전달합니다.
- ADMIN 여부는 프론트엔드 라우트 가드(`middleware` 또는 서버 액션)로 1차 검증하고, API 403 응답 시 재로그인 유도 UI를 노출합니다.
- CSRF 토큰 발급용 Next.js API 라우트(`/api/internal/csrf` 등)를 추가하고, 더블 서브밋 쿠키 전략을 사용해 `X-CSRF-Token` 값을 제공합니다.
- 토큰 만료 시 재인증 UX(모달/알럿/페이지 이동 등)를 정의합니다.

### 4.2 백엔드 보완 작업

- [x] `PostsController` create/update/delete에서 인증된 사용자 ID를 서비스에 전달하고 하드코딩을 제거합니다. (현재 `@User()` 데코레이터 사용)
- [x] `PostsService`의 slug 생성 로직을 `@repo/shared`의 `generateSlug`/`generateEnglishSlug`로 교체하고, 중복 시 `createUniqueSlug`를 활용합니다.
- [x] 포스트 생성·수정·삭제 후 `CategoriesService.updatePostCount` 및 `TagsService.updatePostCount(s)`를 호출해 통계를 맞춥니다.
- [ ] 카테고리/태그 CRUD 응답에 최신 `postCount`를 반환하도록 서비스 로직을 보완합니다.
- [ ] CSRF 토큰 검증을 실제 서명 값 비교로 확장합니다(예: JWT 기반 토큰 또는 암호화된 난수 검증).
- [ ] 신규/변경 로직에 대한 유닛·통합 테스트를 추가합니다(`posts.service.spec.ts`, `posts.integration.spec.ts` 등).

### 4.3 프론트엔드 관리자 UI 구조

- App Router 기준 라우팅을 다음과 같이 구성합니다:
  - `/admin` 대시보드(요약 위젯, 최근 초안 목록).
  - `/admin/posts` 목록, `/admin/posts/new`, `/admin/posts/[slug]/edit`.
  - `/admin/categories`, `/admin/tags` 관리 페이지.
- 공통 레이아웃(`app/admin/layout.tsx`)에 사이드바, 헤더, 세션 만료 안내, 로딩 스피너를 구현합니다.
- 데이터 패칭은 서버 컴포넌트에서 Access Token/CSRF 포함 fetch를 사용하고, 클라이언트 상호작용은 서버 액션 또는 mutation 헬퍼로 처리합니다.
- shadcn/ui 컴포넌트와 기존 색상 토큰(`globals.css`)을 적용해 스타일 일관성을 유지합니다.
- 접근 제어는 `generateMetadata`와 라우트 세그먼트에서 `redirect('/auth/signin')` 처리로 보강합니다.

### 4.4 포스트 작성/수정 플로우

- MDX 에디터는 기본적으로 `textarea + 실시간 미리보기`로 구성하고 향후 전문 에디터 교체 여지를 남깁니다.
- 필수 입력: 제목, 본문, 카테고리, 태그(최소 1개), 발행 여부.
- 자동 처리:
  - 제목 변경 시 slug 자동 생성 + 수동 수정 허용.
  - 본문 첫 문단에서 excerpt 자동 제안.
  - 발행 상태 on/off에 따라 `publishedAt` 갱신, 초안 저장은 `published=false`로 전송.
- 제출 UX: 저장 중 상태 표시, 성공 시 토스트, 실패 시 서버 메시지 표준화.
- 미리보기: 미저장 변경사항을 기반으로 임시 렌더링(`MDXRenderer` 재사용).
- 삭제 플로우: 이중 확인 모달과 완료 후 `/admin/posts` 이동 경로 제공.

### 4.5 카테고리/태그 관리

- 목록 화면에서 검색(이름/슬러그), 정렬, 페이지네이션을 제공합니다.
- 생성·수정 시 slug 자동 생성, 중복 에러 메시지 표준화를 구현합니다.
- 삭제 시 포스트 참조 수를 확인하여 `ConflictException` 메시지를 사용자에게 노출합니다.
- 태그 다중 선택 UX를 개선합니다(자동 완성, 최근 사용 태그 제안).
- 카테고리 색상(`color` 필드) 입력을 지원하고 HEX 유효성 검사를 수행합니다.

### 4.6 API 클라이언트 확장

- `lib/api-client.ts`에 POST/PUT/DELETE 메서드를 추가하고 `token`, `csrfToken` 옵션을 필수로 받도록 확장합니다.
- 오류 공통 처리: `ApiError`를 사용해 401/403 시 재로그인 플로우를 트리거합니다.
- 서버 액션/클라이언트 훅(`useAdminPosts` 등)을 구성해 낙관적 업데이트 및 로딩 상태를 캡슐화합니다.

### 4.7 모니터링 및 테스트

- 관리자 주요 플로우에 대한 Playwright 또는 Cypress e2e 시나리오 초안을 작성합니다.
- Swagger 문서에 관리자 전용 예시를 추가하여 Authorization/CSRF 헤더 사용법을 명시합니다.
- 배포 전 체크리스트: DB 마이그레이션, `ADMIN_EMAIL` 환경 변수 검증, JWT/CSRF 시크릿 재확인.

## 5. 구현 순서 제안

1. 백엔드 보완(작성자 ID, slug, postCount, CSRF 검증).
2. API 클라이언트 및 인증 파이프라인 구축.
3. 관리자 레이아웃과 목록 페이지 골격 작성.
4. 포스트 작성/수정 플로우 구현.
5. 카테고리/태그 관리 추가.
6. 통합 테스트 및 e2e 작성, 문서/Swagger 업데이트.

## 6. 참고

- 인증 관련 코드: `apps/blog-web/lib/auth-config.ts`, `apps/blog-api/src/auth/guards/*`.
- 포스트 서비스: `apps/blog-api/src/posts/posts.service.ts`.
- 슬러그 유틸: `packages/shared/src/utils/slug.ts`.
- 기존 공개 UI 스타일 참조: `apps/blog-web/app/page.tsx`, `apps/blog-web/components/*`.
