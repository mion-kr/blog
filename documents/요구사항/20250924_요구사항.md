# 포스트 목록 화면 - 카테고리, 태그 버튼 미 동작 버그 분석 및 해결방안

## 📋 버그 개요

### 🐛 발생한 문제

- **위치**: `/posts` 페이지의 카테고리 필터 드롭다운 버튼
- **CSS 클래스**: `inline-flex items-center gap-2 px-4 py-2 text-sm font-medium border rounded-lg transition-colors bg-[var(--color-card)] text-[var(--color-text-primary)] border-[var(--color-border)] hover:border-[var(--color-border-hover)]`
- **증상**: 카테고리를 선택하면 URL만 변경되고 실제 필터링이 동작하지 않음
- **발견일**: 2025-09-24

### 📊 버그 재현 과정

1. `http://localhost:3000/posts` 접속
2. 카테고리 드롭다운 클릭
3. "개발" 카테고리 선택
4. **결과**: URL은 `?categoryId=019950fa-13a4-7ebd-ad20-d1f5003a692a&page=1`로 변경되지만 포스트 필터링 미동작
5. 다른 카테고리 선택 시에도 동일한 문제 발생

---

## 🔍 상세 분석 결과

### 1. 코드 구조 분석

#### 📁 관련 파일 구조

```
apps/blog-web/app/posts/
├── page.tsx                    # 메인 페이지 컴포넌트
├── posts-content.tsx          # 포스트 목록 및 필터 로직
├── posts-filter.tsx           # 필터 UI 컴포넌트 ⚠️ 버그 발생 지점
└── posts-pagination.tsx       # 페이지네이션 컴포넌트

apps/blog-web/components/layout/sidebar/
└── category-list.tsx          # 사이드바 카테고리 링크 ⚠️ 관련 이슈
```

### 2. 핵심 문제점 분석

#### 🚨 문제 1: URL 파라미터 이름 불일치

**파일**: `apps/blog-web/app/posts/posts-content.tsx`

```typescript
// 라인 67: URL에서 파라미터를 읽을 때
const currentQuery: PostsQuery = {
  categoryId: searchParams.category || undefined, // ❌ 'category' 읽음
  // ... 기타 파라미터들
};

// 라인 75-92: URL 업데이트 함수
const updateURL = useCallback(
  (newParams: Partial<PostsQuery>) => {
    const params = new URLSearchParams(urlSearchParams.toString());

    Object.entries(newParams).forEach(([key, value]) => {
      if (value !== undefined && value !== null && value !== "") {
        params.set(key, String(value)); // ❌ 'categoryId' 키를 그대로 사용
      }
    });

    router.push(`/posts?${params.toString()}`, { scroll: false });
  },
  [router, urlSearchParams]
);
```

**문제점**:

- URL에서 `category` 파라미터를 찾는데, URL 생성 시에는 `categoryId`를 사용
- 결과적으로 필터링이 동작하지 않음

#### 🚨 문제 2: 카테고리 선택 핸들러 오류

**파일**: `apps/blog-web/app/posts/posts-filter.tsx`

```typescript
// 라인 153-155: 카테고리 변경 핸들러
const handleCategoryChange = useCallback((categoryId: string) => {
  updateURL({ categoryId: categoryId || undefined, page: 1 });  // ❌ 'categoryId'로 URL 생성
}, [updateURL]);

// 라인 185-188: 카테고리 선택 이벤트
onClick={() => {
  onCategoryChange(category.id);  // ✅ category.id 전달은 정상
  setShowCategoryDropdown(false);
}}
```

**문제점**:

- `categoryId` 키로 URL 파라미터를 생성하지만, 읽을 때는 `category`를 찾음

#### 🚨 문제 3: 사이드바와 필터 간 불일치

**파일**: `apps/blog-web/components/layout/sidebar/category-list.tsx`

```typescript
// 라인 30: 사이드바 카테고리 링크
href={`/posts?category=${category.slug}`}  // ✅ 'category' 사용, but slug 사용
```

**파일**: `apps/blog-web/app/posts/posts-filter.tsx`

```typescript
// 카테고리 필터에서는 category.id 사용
onCategoryChange(category.id); // ❌ ID 사용
```

**문제점**:

- 사이드바: `?category=slug` 형태 사용
- 필터: `?categoryId=uuid` 형태 생성
- 값 타입도 다름 (slug vs uuid)

### 3. Playwright 테스트 검증 결과

#### 🧪 테스트 과정

```yaml
1. 초기 상태: http://localhost:3000/posts
   - 카테고리 버튼 상태: "카테고리" (기본값)
   - 총 포스트 수: 1개

2. 카테고리 드롭다운 클릭
   - 드롭다운 메뉴 정상 표시
   - 옵션들: 전체 카테고리, 개발, 튜토리얼, 회고

3. "개발" 카테고리 선택
   - URL 변경: ?categoryId=019950fa-13a4-7ebd-ad20-d1f5003a692a&page=1
   - 카테고리 버튼: 여전히 "카테고리" (❌ 선택된 카테고리명 미표시)
   - 포스트 목록: 변경 없음 (❌ 필터링 미동작)

4. "튜토리얼" 카테고리 선택
   - URL 변경: ?categoryId=019950fa-13a4-7ebd-ad20-d1f77b273123&page=1
   - 동일한 문제 재현
```

#### ✅ 확인된 사실들

- URL 파라미터 변경은 정상 동작
- 드롭다운 UI 인터랙션은 정상
- 카테고리 데이터 로딩은 정상
- 문제는 순전히 파라미터 이름 불일치

---

## 🛠️ 해결 방안

### 🎯 **최종 결정: Slug 기반 필터링 구현** ⭐

**결정 근거**:

- 사용자 친화적 URL (`?category=development` vs `?categoryId=uuid`)
- SEO 최적화 및 북마크 친화성
- 업계 표준 패턴 (WordPress, Medium, Dev.to 등 대부분 slug 사용)

---

### 💡 **구현 방안: 하이브리드 Slug 시스템**

#### **1. 백엔드 API 확장 (개발자가 직접 수정 예정)**

```typescript
// @repo/shared/src/types/api.ts - PostsQuery 확장
export interface PostsQuery extends PaginationQuery {
  published?: boolean;
  categoryId?: string; // 기존 ID 지원 (하위 호환성)
  categorySlug?: string; // 🆕 새로 추가
  tagId?: string; // 기존 ID 지원 (하위 호환성)
  tagSlug?: string; // 🆕 새로 추가
  search?: string;
  authorId?: string;
}
```

#### **2. 프론트엔드 구현 방안**

##### **수정 파일 1: `apps/blog-web/app/posts/posts-content.tsx`**

```typescript
// URL 파라미터 파싱 로직 수정 (라인 62-72)
const currentQuery: PostsQuery = {
  page: parseInt(searchParams.page ?? "1", 10),
  limit: parseInt(searchParams.limit ?? "12", 10),
  search: searchParams.search || undefined,
  // 🔥 핵심 변경: slug 우선, ID는 하위 호환성
  categorySlug: searchParams.category || undefined, // slug 사용
  tagSlug: searchParams.tag || undefined, // slug 사용
  sort: searchParams.sort || "publishedAt",
  order: searchParams.order || "desc",
  published: true,
};
```

---

### 📈 **예상 URL 패턴 변화**

#### **현재 (버그 있음)**

```bash
❌ /posts?categoryId=019950fa-13a4-7ebd-ad20-d1f5003a692a  # 동작 안함
❌ /posts?category=019950fa-13a4-7ebd-ad20-d1f5003a692a    # 사이드바만 동작
```

#### **수정 후 (권장)**

```bash
✅ /posts?category=development          # 직관적이고 SEO 친화적
✅ /posts?category=tutorial             # 사용자가 이해하기 쉬움
✅ /posts?tag=nextjs                    # 태그도 동일한 방식
✅ /posts?category=development&tag=react # 조합 필터링
```

#### **하위 호환성 (기존 북마크 지원)**

```bash
✅ /posts?categoryId=uuid-123           # 기존 방식도 지원
✅ /posts?tagId=uuid-456               # 기존 태그 ID도 지원
```

---

## 📊 **Slug 기반 시스템의 장점**

### ✅ **사용자 경험 개선**

- **직관적인 URL**: `/posts?category=development` - 한눈에 알 수 있음
- **공유 친화적**: 소셜미디어나 메시지로 공유할 때 신뢰성 증가
- **북마크 효율성**: 의미 있는 URL로 북마크 관리가 용이

### ✅ **SEO 최적화**

- **검색엔진 크롤링**: 검색엔진이 URL의 의미를 정확히 파악
- **키워드 가중치**: URL에 포함된 키워드가 SEO에 긍정적 영향
- **구조화된 데이터**: 웹사이트의 정보 구조가 명확해짐

### ✅ **개발자 친화성**

- **디버깅 용이**: 개발 중 URL만 보고도 상황 파악 가능
- **로그 분석**: 서버 로그에서 어떤 카테고리가 많이 조회되는지 쉽게 파악
- **업계 표준**: WordPress, Ghost, Medium 등 대부분의 CMS가 사용하는 패턴

### ✅ **하위 호환성 보장**

- **기존 북마크 지원**: `?categoryId=uuid` 형태의 기존 URL도 계속 동작
- **점진적 마이그레이션**: 새로운 링크는 slug, 기존 링크는 ID로 처리
- **API 유연성**: 백엔드에서 slug와 ID 모두 처리하여 안정성 확보

---

## ✅ 검증 계획

### 🧪 테스트 시나리오

1. **카테고리 필터 동작 확인**
   - 카테고리 선택 시 포스트 목록 필터링 동작
   - 선택된 카테고리명이 버튼에 표시
   - URL 파라미터 정상 생성

2. **사이드바 카테고리 링크 동작 확인**
   - 사이드바에서 카테고리 클릭 시 필터 적용
   - 필터와 사이드바 간 상호 호환성

3. **태그 필터 동작 확인**
   - 태그 필터도 동일한 문제가 있는지 확인
   - 필요시 동일한 방식으로 수정

4. **페이지네이션 및 기타 필터와의 조합 테스트**
   - 검색 + 카테고리 필터 조합
   - 카테고리 + 태그 필터 조합
   - 정렬 옵션과의 조합

### 🔍 회귀 테스트 포인트

- 기존 북마크된 URL들의 동작 확인
- 검색엔진에서 인덱싱된 URL들과의 호환성
- 브라우저 뒤로가기/앞으로가기 동작

---

## 📅 수정 우선순위

### 🚀 즉시 수정 필요 (High Priority)

1. **카테고리 필터 버그** - 사용자 경험에 직접적 영향
2. **태그 필터 동일 문제 확인** - 동일한 패턴의 버그 가능성

### 📋 후속 개선사항 (Medium Priority)

1. **코드 리뷰 및 일관성 점검** - 다른 필터들의 유사 패턴 확인
2. **타입스크립트 인터페이스 정리** - PostsQuery 타입 명확화
3. **테스트 코드 추가** - 필터 동작에 대한 자동화 테스트

---

## 📝 참고 정보

### 🗂️ 관련 타입 정의

```typescript
// @repo/shared에서 정의된 PostsQuery 인터페이스
interface PostsQuery {
  page?: number;
  limit?: number;
  search?: string;
  categoryId?: string; // ⚠️ 'categoryId' 사용
  tagId?: string; // ⚠️ 'tagId' 사용
  sort?: string;
  order?: "asc" | "desc";
  published?: boolean;
}
```

### 🔗 관련 API 엔드포인트

- `GET /api/posts` - PostsQuery를 받아서 포스트 목록 반환
- API는 `categoryId`, `tagId` 파라미터 기대

### 📱 브라우저 호환성

- 모든 모던 브라우저에서 동일한 문제 발생 확인
- URLSearchParams API 정상 동작
- 문제는 순전히 로직 오류

---

## 👥 검토자 정보

- **분석자**: Claude AI Assistant
- **분석일**: 2025-09-24
- **분석 방법**: 정적 코드 분석 + Playwright 동적 테스트
- **검증 환경**: Next.js 15, localhost:3000

---

## 📋 체크리스트

### ✅ 완료된 분석

- [x] 버그 재현 및 확인
- [x] 코드 정적 분석
- [x] Playwright를 통한 동적 테스트
- [x] 근본 원인 파악
- [x] 해결 방안 도출
- [x] 영향도 분석

### ⏳ 대기 중인 작업

#### **백엔드 작업 (개발자 직접 수행)**

- [ ] @repo/shared PostsQuery 타입에 categorySlug, tagSlug 필드 추가
- [ ] NestJS DTO에 categorySlug, tagSlug 파라미터 추가
- [ ] PostsService에서 slug 기반 필터링 로직 구현
- [ ] 하위 호환성을 위한 ID 기반 필터링도 유지

#### **프론트엔드 작업 (Claude 수행 가능)**

- [ ] posts-content.tsx에서 categorySlug, tagSlug 사용하도록 수정
- [ ] posts-filter.tsx에서 slug 기반 URL 생성하도록 수정
- [ ] category-list.tsx는 이미 slug 사용 중이므로 유지
- [ ] 하위 호환성 테스트 (기존 categoryId, tagId URL 동작 확인)

#### **검증 작업**

- [ ] Playwright를 이용한 동적 테스트
- [ ] 다양한 URL 패턴 동작 확인
- [ ] SEO 메타데이터 확인
